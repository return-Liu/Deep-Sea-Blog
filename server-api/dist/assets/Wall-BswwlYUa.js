import{d as Ee,e as _,A as pe,B as Ne,O as me,c,f as l,J as P,K as R,s as $,a2 as G,h as p,k as L,w as r,T as ve,y as D,a as o,Q as Te,n as C,E as n,r as I,i as qe,L as Ae,o as u,N as F,m as Ge,x as V,z as J,M as Fe,I as He,aa as K,F as T,ad as fe,ae as ye,af as _e}from"./index-DaoAQrrJ.js";import{H as Oe}from"./HeartOutlined-CqtU-ya3.js";import{D as ge}from"./DeleteOutlined-BzePei8I.js";import{_ as je}from"./_plugin-vue_export-helper-DlAUqK2U.js";const he=[{id:"全部",name:"全部"},{id:"留言",name:"留言"},{id:"目标",name:"目标"},{id:"理想",name:"理想"},{id:"过去",name:"过去"},{id:"将来",name:"将来"},{id:"爱情",name:"爱情"},{id:"亲情",name:"亲情"},{id:"友情",name:"友情"},{id:"秘密",name:"秘密"},{id:"信条",name:"信条"},{id:"无题",name:"无题"}],ke=[{id:"全部",name:"全部"},{id:"照片",name:"照片"},{id:"风景",name:"风景"},{id:"人像",name:"人像"},{id:"美食",name:"美食"},{id:"建筑",name:"建筑"},{id:"艺术",name:"艺术"},{id:"旅行",name:"旅行"},{id:"花卉",name:"花卉"},{id:"天空",name:"天空"},{id:"城市",name:"城市"},{id:"无题",name:"无题"}],f=[];for(let s=0;s<256;++s)f.push((s+256).toString(16).slice(1));function Je(s,d=0){return(f[s[d+0]]+f[s[d+1]]+f[s[d+2]]+f[s[d+3]]+"-"+f[s[d+4]]+f[s[d+5]]+"-"+f[s[d+6]]+f[s[d+7]]+"-"+f[s[d+8]]+f[s[d+9]]+"-"+f[s[d+10]]+f[s[d+11]]+f[s[d+12]]+f[s[d+13]]+f[s[d+14]]+f[s[d+15]]).toLowerCase()}let Q;const Ke=new Uint8Array(16);function Qe(){if(!Q){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Q=crypto.getRandomValues.bind(crypto)}return Q(Ke)}const Xe=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),we={randomUUID:Xe};function be(s,d,y){var g;if(we.randomUUID&&!s)return we.randomUUID();s=s||{};const k=s.random??((g=s.rng)==null?void 0:g.call(s))??Qe();if(k.length<16)throw new Error("Random bytes length must be >= 16");return k[6]=k[6]&15|64,k[8]=k[8]&63|128,Je(k)}const Ye={class:"walls-container"},Ze={class:"walls-nav"},et={class:"nav-list"},tt=["onClick"],at={class:"category-filter"},lt={class:"filter-group"},ot=["onClick"],st={class:"filter-group"},nt=["onClick"],rt={class:"walls-main"},ut={class:"card-header"},it={class:"card-title"},dt={class:"message-category"},ct={class:"card-content"},pt={key:0,class:"card-media"},mt={alt:"留言图片",class:"media-image"},vt=["onClick"],ft={class:"message-likes"},yt={style:{"margin-left":"5px"},class:"likes-count"},_t=["onClick"],gt=["onClick"],ht={alt:"照片",class:"photo-image"},kt={class:"photo-caption"},wt=["onClick"],bt={class:"photo-category"},Ct={key:2,class:"empty-state"},It={key:3,class:"empty-state"},xt={class:"floating-actions"},Vt={class:"photo-upload-text"},Ut={key:0,class:"uploaded-image"},$t={key:1,class:"upload-placeholder"},Dt={class:"form-actions"},St={class:"photo-upload-text"},Mt={key:0,class:"uploaded-image"},Pt={key:1,class:"upload-placeholder"},Rt={class:"form-actions"},Lt=Ee({__name:"Wall",props:{tab:{type:String,default:"messages"},category:{type:String,default:null}},setup(s){const d=s,y=_({id:null,name:"",content:"",photo:"",userId:null,category:null,likesCount:0}),k=_({id:null,photo:"",date:"",userId:null,category:null}),g=_([]),S=_([]),Ce=[{id:"messages",title:"留言墙"},{id:"photos",title:"照片墙"}],M=Te(),H=qe(),h=_(d.tab),w=_(d.category),O=_(!1),X=_(null),Y=_(null),B=_(!1),E=_(!1),U=_(null),x=_(null),b=_(null);async function Ie(){try{const t=await C.get("/users/me");b.value=t.data.data.id}catch{console.log("获取信息失败"),n.error("获取信息失败")}}const Z=pe(()=>!w.value||w.value==="全部"?g.value:g.value.filter(t=>t.category===w.value)),ee=pe(()=>!w.value||w.value==="全部"?S.value:S.value.filter(t=>t.category===w.value)),te=async t=>{try{const e={};t&&(e.category=t);const[i,m]=await Promise.all([C.get("/admin/wall",{params:e}),C.get("/admin/photo")]);i.data.status?g.value=i.data.data.walls.map(v=>({id:v.id.toString(),content:v.content,name:v.name,photo:v.photo,userId:v.userId,category:v.category,likesCount:v.likesCount||0,isLiked:!1})):n.error(i.data.message),m.data.status?S.value=m.data.data.photos.map(v=>({id:v.id.toString(),photo:v.photo,date:v.createdAt,userId:v.userId,category:v.category})):n.error(m.data.message)}catch{n.error("获取留言墙和照片墙数据失败")}},xe=t=>{const e=t.id;w.value=e,H.replace({name:"wall",params:{tab:"messages"},query:{category:e}})},Ve=t=>{const e=t.id;w.value=e,H.replace({name:"wall",params:{tab:"photos"},query:{category:e}})},Ue=t=>{h.value=t,H.replace({name:"wall",params:{tab:t}})},ae=async t=>{t==="wall"?(N(!0),X.value.submit()):t==="photo"&&(N(!0),Y.value.submit())};Ne(()=>{M.params.tab&&(h.value=M.params.tab),M.query.category?(w.value=M.query.category,te(M.query.category)):te(),Ie()});const le=()=>{U.value=null,x.value=null,B.value=!1,E.value=!1},oe=t=>{const i=["image/jpeg","image/png","image/webp","image/gif"].includes(t.type),m=t.size/1024/1024<2;return i||n.error("上传照片只能是 JPG 或 PNG 或 WEBP 或 GIF 格式!"),m||n.error("上传照片大小不能超过 2MB!"),N(!0),i&&m},se=(t,e,i)=>{i==="wall"?x.value=`${T}/photo/${t.data.photo}`:i==="photo"&&(U.value=`${T}/photo/${t.data.photo}`),n.success("照片上传成功")},$e=(t,e)=>{se(t,e,"wall")},De=(t,e)=>{se(t,e,"photo")},Se=(t,e)=>{console.error("文件上传错误:",t),n.error("文件上传失败，请重试")},ne=(t,e)=>{O.value=e.length>0},Me=async(t,e)=>{try{const i=await C.post("/admin/likeswall/like",{wallsId:t,userId:b.value}),m=g.value.findIndex(v=>v.id===t);m!==-1&&(g.value[m].isLiked=!e,g.value[m].likesCount=i.data.likeCount)}catch(i){console.error("点赞失败:",i),n.error("点赞失败，请重试")}},Pe=async t=>{try{await C.delete(`/admin/wall/${t}`);const e=g.value.findIndex(i=>i.id===t);e!==-1&&g.value.splice(e,1),N(),n.success("删除成功")}catch(e){console.error("删除失败:",e),n.error("删除失败，请重试")}},Re=async t=>{await C.post(`/admin/wall/report/${t}`,{userId:b.value,content:"举报内容: 该留言存在违规行为,请管理员尽快处理"}),n.success("举报成功,感谢你的举报")},Le=async t=>{try{await C.delete(`/admin/photo/${t}`);const e=S.value.findIndex(i=>i.id===t);e!==-1&&S.value.splice(e,1),N(),n.success("删除成功")}catch(e){console.error("删除失败:",e),n.error("删除失败，请重试")}},We=async()=>{try{if(!x.value){n.error("请先上传照片");return}if(!y.value.content){n.error("请输入留言内容");return}if(!y.value.name){n.error("请输入留言昵称");return}if(b.value===null){n.error("用户ID为空，请重试");return}if(!y.value.category){n.error("请选择留言分类");return}const t={photo:x.value,content:y.value.content,name:y.value.name,userId:b.value,category:y.value.category,likesCount:y.value.likesCount};await C.post("/admin/wall",t),g.value.push({id:be(),...t,isLiked:!1}),B.value=!1,n.success("留言保存成功"),y.value={id:null,name:"",content:"",photo:"",userId:null,category:null,likesCount:0},x.value=null}catch(t){console.error("保存留言失败:",t)}},ze=async()=>{try{if(!U.value){n.error("请先上传照片");return}if(!k.value.category){n.error("请选择照片分类");return}if(b.value===null){n.error("用户ID为空，请重试");return}const t={photo:U.value,date:re(new Date().toString()),userId:b.value,category:k.value.category};await C.post("/admin/photo",t),S.value.push({id:be(),...t}),E.value=!1,n.success("照片保存成功"),k.value={id:null,photo:"",date:"",userId:null,category:null}}catch(t){console.error("保存照片失败:",t),n.error("保存照片失败，请重试")}},N=async(t=!1)=>{try{let e=U.value||x.value;const i=e==null?void 0:e.split("/").pop();if(!i){console.warn("无法从 imageUrl 提取照片名称:",e);return}await C.delete(`${T}/admin/uploadphoto/photo/${i}`),U.value=null,x.value=null,t?n.success("已删除未使用的照片,如需重新上传,请点击上传按钮"):n.success("旧照片已删除, 已重新上传新照片")}catch(e){console.error("删除照片失败:",e),n.error("删除失败")}};me(()=>M.params.tab,t=>{t&&(h.value=t)}),me(()=>M.params.category,t=>{t&&(w.value=t)});const re=t=>new Date(t).toLocaleString();return(t,e)=>{const i=I("el-empty"),m=I("el-icon"),v=I("el-tooltip"),ue=I("el-input"),W=I("el-form-item"),ie=I("el-option"),de=I("el-select"),ce=I("el-upload"),q=I("el-button"),Be=I("el-form"),A=Ae("lazy");return u(),c("div",Ye,[l("nav",Ze,[l("ul",et,[(u(),c(P,null,R(Ce,a=>l("li",{key:a.id,class:F(["nav-item",{active:h.value===a.id}]),onClick:z=>Ue(a.id)},[Ge(V(a.title)+" ",1),e[9]||(e[9]=l("div",{class:"active-indicator"},null,-1))],10,tt)),64))]),e[10]||(e[10]=l("p",{class:"nav-desc"},"记录美好瞬间，珍藏珍贵回忆",-1))]),l("section",at,[$(l("div",lt,[(u(!0),c(P,null,R(p(he),a=>(u(),c("button",{key:a.id,class:F(["filter-btn",{active:w.value===a.id}]),onClick:z=>xe(a)},V(a.name),11,ot))),128))],512),[[G,h.value==="messages"]]),$(l("div",st,[(u(!0),c(P,null,R(p(ke),a=>(u(),c("button",{key:a.id,class:F(["filter-btn",{active:w.value===a.id}]),onClick:z=>Ve(a)},V(a.name),11,nt))),128))],512),[[G,h.value==="photos"]])]),l("main",rt,[h.value==="messages"?(u(),L(ve,{key:0,name:"staggered-fade",tag:"div",class:"message-grid"},{default:r(()=>[(u(!0),c(P,null,R(Z.value,(a,z)=>(u(),c("article",{key:z,class:F(["message-card",{"has-media":a.photo}])},[l("header",ut,[l("h3",it,V(a.name),1),l("span",dt,V(a.category),1)]),l("div",ct,[l("p",null,V(a.content),1)]),a.photo?(u(),c("div",pt,[$(l("img",mt,null,512),[[A,a.photo]])])):D("",!0),l("div",{class:"message-icon",onClick:j=>Me(a.id,a.isLiked)},[l("div",ft,[o(p(Oe)),l("span",yt,V(a.likesCount),1)]),$(l("div",{class:"message-delete",onClick:J(j=>Pe(a.id),["stop"])},[o(p(ge))],8,_t),[[G,b.value===4]]),b.value!==a.userId?(u(),c("div",{key:0,class:"message-report",onClick:J(j=>Re(a.id),["stop"])},e[11]||(e[11]=[l("span",null,"举报此留言",-1)]),8,gt)):D("",!0)],8,vt)],2))),128))]),_:1})):D("",!0),h.value==="photos"?(u(),L(ve,{key:1,name:"staggered-fade",tag:"div",class:"photo-grid"},{default:r(()=>[(u(!0),c(P,null,R(ee.value,(a,z)=>(u(),c("figure",{key:z,class:"photo-card"},[$(l("img",ht,null,512),[[A,a.photo]]),l("figcaption",kt,[$(l("div",{style:{color:"red","margin-right":"10px"},class:"photo-delete",onClick:J(j=>Le(a.id),["stop"])},[o(p(ge))],8,wt),[[G,b.value===4]]),l("time",null,V(re(a.date)),1),l("div",bt,V(a.category),1)])]))),128))]),_:1})):D("",!0),h.value==="messages"&&!Z.value.length?(u(),c("div",Ct,[o(i,{description:"暂无留言，快来留下第一个足迹吧~"})])):D("",!0),h.value==="photos"&&!ee.value.length?(u(),c("div",It,[o(i,{description:"还没有照片，点击右下角上传吧"})])):D("",!0)]),l("div",xt,[o(v,{effect:"dark",content:h.value==="messages"?"写留言":"传照片",placement:"left"},{default:r(()=>[l("button",{class:"fab-button",onClick:e[0]||(e[0]=a=>h.value==="messages"?B.value=!0:E.value=!0)},[o(m,{size:24},{default:r(()=>[(u(),L(Fe(h.value==="messages"?p(He):p(K))))]),_:1})])]),_:1},8,["content"])]),o(p(_e),{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=a=>B.value=a),title:"添加留言",direction:"rtl",size:"40%","before-close":le,"close-on-click-modal":!1},{default:r(()=>[o(Be,{class:"message-form","label-width":"100px"},{default:r(()=>[o(W,{label:"留言昵称"},{default:r(()=>[o(ue,{modelValue:y.value.name,"onUpdate:modelValue":e[1]||(e[1]=a=>y.value.name=a),placeholder:"请输入留言昵称"},null,8,["modelValue"])]),_:1}),o(W,{label:"留言内容"},{default:r(()=>[o(ue,{modelValue:y.value.content,"onUpdate:modelValue":e[2]||(e[2]=a=>y.value.content=a),type:"textarea",rows:4,placeholder:"请输入留言内容"},null,8,["modelValue"])]),_:1}),o(W,{label:"留言标签"},{default:r(()=>[o(de,{modelValue:y.value.category,"onUpdate:modelValue":e[3]||(e[3]=a=>y.value.category=a),placeholder:"请选择标签",clearable:""},{default:r(()=>[(u(!0),c(P,null,R(p(he),a=>(u(),L(ie,{key:a.id,label:a.name,value:a.id,disabled:a.id==="全部"},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(W,{label:"留言照片"},{default:r(()=>[o(ce,{class:"wall-uploader",action:`${p(T)}/admin/uploadphoto`,"show-file-list":!1,"before-upload":oe,"on-success":$e,method:"post",name:"photo","auto-upload":!1,ref_key:"uploadWallRef",ref:X,onChange:ne},{default:r(()=>[l("div",Vt,[x.value?$((u(),c("img",Ut,null,512)),[[A,x.value]]):(u(),c("div",$t,[o(m,null,{default:r(()=>[o(p(K))]),_:1}),e[12]||(e[12]=l("p",null,"请选择要上传的留言照片",-1))]))])]),_:1},8,["action"])]),_:1}),o(W,null,{default:r(()=>[l("div",Dt,[O.value?(u(),L(q,{key:0,type:"primary",onClick:e[4]||(e[4]=a=>ae("wall"))},{default:r(()=>[o(m,null,{default:r(()=>[o(p(fe))]),_:1}),e[13]||(e[13]=l("span",null,"上传留言照片",-1))]),_:1})):D("",!0),o(q,{type:"primary",onClick:We},{default:r(()=>[o(m,null,{default:r(()=>[o(p(ye))]),_:1}),e[14]||(e[14]=l("span",null,"保存留言",-1))]),_:1})])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(p(_e),{modelValue:E.value,"onUpdate:modelValue":e[8]||(e[8]=a=>E.value=a),"before-close":le,title:"上传照片",direction:"rtl",size:"40%","close-on-click-modal":!1},{default:r(()=>[o(ce,{class:"photo-uploader",action:`${p(T)}/admin/uploadphoto`,"show-file-list":!1,"before-upload":oe,"on-success":De,"on-error":Se,method:"post",name:"photo","auto-upload":!1,ref_key:"uploadPhotoRef",ref:Y,onChange:ne},{default:r(()=>[l("div",St,[U.value?$((u(),c("img",Mt,null,512)),[[A,U.value]]):(u(),c("div",Pt,[o(m,null,{default:r(()=>[o(p(K))]),_:1}),e[15]||(e[15]=l("p",null,"请选择要上传的照片",-1))]))])]),_:1},8,["action"]),o(W,{label:"照片标签",style:{"margin-top":"20px"}},{default:r(()=>[o(de,{modelValue:k.value.category,"onUpdate:modelValue":e[6]||(e[6]=a=>k.value.category=a),placeholder:"请选择照片标签"},{default:r(()=>[(u(!0),c(P,null,R(p(ke),a=>(u(),L(ie,{key:a.id,label:a.name,value:a.id,disabled:a.id==="全部"},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),l("div",Rt,[O.value?(u(),L(q,{key:0,type:"primary",onClick:e[7]||(e[7]=a=>ae("photo"))},{default:r(()=>[o(m,null,{default:r(()=>[o(p(fe))]),_:1}),e[16]||(e[16]=l("span",null,"上传照片",-1))]),_:1})):D("",!0),o(q,{type:"primary",onClick:ze},{default:r(()=>[o(m,null,{default:r(()=>[o(p(ye))]),_:1}),e[17]||(e[17]=l("span",null,"保存照片",-1))]),_:1})])]),_:1},8,["modelValue"])])}}}),Nt=je(Lt,[["__scopeId","data-v-ea58c707"]]);export{Nt as default};
