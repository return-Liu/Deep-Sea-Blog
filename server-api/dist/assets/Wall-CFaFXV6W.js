import{d as qe,e as y,u as Je,P as K,A as Ge,a2 as fe,c,f as o,U as N,V as R,k as V,t as E,O as ge,h as v,ac as ye,w as u,a3 as _e,z as I,a as l,M as He,n as C,E as r,Y as T,r as S,i as je,T as Fe,o as s,a1 as G,m as Ke,y as $,s as Y,a0 as Ye,$ as Qe,a9 as Q,ad as he,ae as ke,af as we}from"./index-BDg1WjkS.js";import{H as Xe}from"./HeartOutlined-4517EROV.js";import{D as be}from"./DeleteOutlined-9Muhh3ma.js";import{_ as Ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ce=[{id:"全部",name:"全部"},{id:"留言",name:"留言"},{id:"目标",name:"目标"},{id:"理想",name:"理想"},{id:"过去",name:"过去"},{id:"将来",name:"将来"},{id:"爱情",name:"爱情"},{id:"亲情",name:"亲情"},{id:"友情",name:"友情"},{id:"秘密",name:"秘密"},{id:"信条",name:"信条"},{id:"无题",name:"无题"}],Ie=[{id:"全部",name:"全部"},{id:"照片",name:"照片"},{id:"风景",name:"风景"},{id:"人像",name:"人像"},{id:"美食",name:"美食"},{id:"建筑",name:"建筑"},{id:"艺术",name:"艺术"},{id:"旅行",name:"旅行"},{id:"花卉",name:"花卉"},{id:"天空",name:"天空"},{id:"城市",name:"城市"},{id:"无题",name:"无题"}],f=[];for(let n=0;n<256;++n)f.push((n+256).toString(16).slice(1));function et(n,m=0){return(f[n[m+0]]+f[n[m+1]]+f[n[m+2]]+f[n[m+3]]+"-"+f[n[m+4]]+f[n[m+5]]+"-"+f[n[m+6]]+f[n[m+7]]+"-"+f[n[m+8]]+f[n[m+9]]+"-"+f[n[m+10]]+f[n[m+11]]+f[n[m+12]]+f[n[m+13]]+f[n[m+14]]+f[n[m+15]]).toLowerCase()}let X;const tt=new Uint8Array(16);function at(){if(!X){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");X=crypto.getRandomValues.bind(crypto)}return X(tt)}const lt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Se={randomUUID:lt};function Ue(n,m,g){var _;if(Se.randomUUID&&!n)return Se.randomUUID();n=n||{};const k=n.random??((_=n.rng)==null?void 0:_.call(n))??at();if(k.length<16)throw new Error("Random bytes length must be >= 16");return k[6]=k[6]&15|64,k[8]=k[8]&63|128,et(k)}const ot={class:"walls-container"},st={class:"walls-nav"},nt={class:"nav-list"},rt=["onClick"],it={class:"category-filter"},ut={class:"filter-group"},dt=["onClick"],ct={class:"filter-group"},pt=["onClick"],mt={class:"walls-main"},vt={class:"card-header"},ft={class:"card-title"},gt={class:"message-category"},yt={class:"card-content"},_t={key:0,class:"card-media"},ht={alt:"留言图片",class:"media-image"},kt=["onClick"],wt={class:"message-likes"},bt={style:{"margin-left":"5px"},class:"likes-count"},Ct=["onClick"],It=["onClick"],St={alt:"照片",class:"photo-image"},Ut={class:"photo-caption"},Dt=["onClick"],Vt={class:"photo-category"},$t={key:2,class:"empty-state"},xt={key:3,class:"empty-state"},Mt={class:"floating-actions"},Pt={class:"photo-upload-text"},Nt={key:0,class:"uploaded-image"},Rt={key:1,class:"upload-placeholder"},Tt={class:"form-actions"},Wt={class:"photo-upload-text"},zt={key:0,class:"uploaded-image"},Et={key:1,class:"upload-placeholder"},Lt={class:"form-actions"},At=qe({__name:"Wall",props:{tab:{type:String,default:"messages"},category:{type:String,default:null}},setup(n){var ce;const m=n,g=y({id:null,name:"",content:"",photo:"",userId:null,category:null,likesCount:0}),k=y({id:null,photo:"",date:"",userId:null,category:null}),_=y([]),x=y([]),De=[{id:"messages",title:"留言墙"},{id:"photos",title:"照片墙"}],P=He(),H=je(),h=y(m.tab),w=y(m.category),j=y(!1),Z=y(null),ee=y(null),L=y(!1),A=y(!1),U=y(null),D=y(null),b=y(null),B=y(new Set),Ve=Je(),$e=K(()=>Ve.user);b.value=((ce=$e.value)==null?void 0:ce.id)||null;const te=K(()=>!w.value||w.value==="全部"?_.value:_.value.filter(t=>t.category===w.value)),ae=K(()=>!w.value||w.value==="全部"?x.value:x.value.filter(t=>t.category===w.value)),le=async t=>{try{const e={};t&&(e.category=t);const[i,p]=await Promise.all([C.get("/admin/wall",{params:e}),C.get("/admin/photo")]);i.data.status?_.value=i.data.data.walls.map(d=>({id:d.id.toString(),content:d.content,name:d.name,photo:d.photo,userId:d.userId,category:d.category,likesCount:d.likesCount||0,isLiked:!1})):r.error(i.data.message),p.data.status?x.value=p.data.data.photos.map(d=>({id:d.id.toString(),photo:d.photo,date:d.createdAt,userId:d.userId,category:d.category})):r.error(p.data.message)}catch{r.error("获取留言墙和照片墙数据失败")}},xe=t=>{const e=t.id;w.value=e,H.replace({name:"wall",params:{tab:"messages"},query:{category:e}})},Me=t=>{const e=t.id;w.value=e,H.replace({name:"wall",params:{tab:"photos"},query:{category:e}})},Pe=t=>{h.value=t,H.replace({name:"wall",params:{tab:t}})},oe=async t=>{t==="wall"?(O(!0),Z.value.submit()):t==="photo"&&(O(!0),ee.value.submit())};Ge(()=>{P.params.tab&&(h.value=P.params.tab),P.query.category?(w.value=P.query.category,le(P.query.category)):le();const t=new Set(JSON.parse(localStorage.getItem("reportedMessages")||"[]"));B.value=t});const se=()=>{O(!1),U.value=null,D.value=null,L.value=!1,A.value=!1},ne=t=>{const i=["image/jpeg","image/png","image/webp","image/gif"].includes(t.type),p=t.size/1024/1024<2;return i||r.error("上传照片只能是 JPG 或 PNG 或 WEBP 或 GIF 格式!"),p||r.error("上传照片大小不能超过 2MB!"),b.value?(O(!0),i&&p):(r.error("用户ID未找到，请重新登录"),!1)},re=(t,e,i)=>{i==="wall"?D.value=`${T}/photo/${t.data.photo}`:i==="photo"&&(U.value=`${T}/photo/${t.data.photo}`),r.success("照片上传成功")},Ne=(t,e)=>{re(t,e,"wall")},Re=(t,e)=>{re(t,e,"photo")},Te=(t,e)=>{console.error("文件上传错误:",t),r.error("文件上传失败，请重试")},ie=(t,e)=>{j.value=e.length>0},We=async(t,e)=>{try{const i=await C.post("/admin/likeswall/like",{wallsId:t,userId:b.value}),p=_.value.findIndex(d=>d.id===t);p!==-1&&(_.value[p].isLiked=!e,_.value[p].likesCount=i.data.likeCount)}catch(i){console.error("点赞失败:",i),r.error("点赞失败，请重试")}},ue=async(t,e)=>{const i=_.value.find(d=>d.id===t);if(i&&i.photo){const M=i.photo.split("/").pop();M&&await C.delete(`${T}/admin/uploadphoto/photo/${M}`)}const p=x.value.find(d=>d.id===e);if(p){const M=p.photo.split("/").pop();M&&await C.delete(`${T}/admin/uploadphoto/photo/${M}`)}},ze=async t=>{try{await ue(t,""),await C.delete(`/admin/wall/${t}`);const e=_.value.findIndex(i=>i.id===t);e!==-1&&_.value.splice(e,1),B.value.delete(t),localStorage.setItem("reportedMessages",JSON.stringify(Array.from(B.value))),r.success("删除成功")}catch(e){console.error("删除失败:",e),r.error("删除失败，请重试")}},Ee=async t=>{const e=new Set(JSON.parse(localStorage.getItem("reportedMessages")||"[]"));if(e.has(t)){r.warning("你已经举报过该留言，请勿重复举报");return}try{await C.post(`/admin/wall/report/${t}`,{userId:b.value,content:"举报内容: 该留言存在违规行为,请管理员尽快处理"}),e.add(t),B.value=e,localStorage.setItem("reportedMessages",JSON.stringify(Array.from(e))),r.success("举报成功,感谢你的举报")}catch(i){console.error("举报失败:",i),r.error("举报失败，请重试")}},Le=async t=>{try{await ue("",t),await C.delete(`/admin/photo/${t}`);const e=x.value.findIndex(i=>i.id===t);e!==-1&&x.value.splice(e,1),r.success("删除成功")}catch(e){console.error("删除失败:",e),r.error("删除失败，请重试")}},Ae=async()=>{try{if(!D.value){r.error("请先上传照片");return}if(!g.value.content){r.error("请输入留言内容");return}if(!g.value.name){r.error("请输入留言昵称");return}if(b.value===null){r.error("用户ID为空，请重试");return}if(!g.value.category){r.error("请选择留言分类");return}const t={photo:D.value,content:g.value.content,name:g.value.name,userId:b.value,category:g.value.category,likesCount:g.value.likesCount};await C.post("/admin/wall",t),_.value.push({id:Ue(),...t,isLiked:!1}),L.value=!1,r.success("留言保存成功"),g.value={id:null,name:"",content:"",photo:"",userId:null,category:null,likesCount:0},D.value=null}catch(t){console.error("保存留言失败:",t)}},Be=async()=>{try{if(!U.value){r.error("请先上传照片");return}if(!k.value.category){r.error("请选择照片分类");return}if(b.value===null){r.error("用户ID为空，请重试");return}const t={photo:U.value,date:de(new Date().toString()),userId:b.value,category:k.value.category};await C.post("/admin/photo",t),x.value.push({id:Ue(),...t}),A.value=!1,r.success("照片保存成功"),U.value=null,k.value={id:null,photo:"",date:"",userId:null,category:null}}catch(t){console.error("保存照片失败:",t),r.error("保存照片失败，请重试")}},O=async(t=!1)=>{try{let e=U.value||D.value;const i=e==null?void 0:e.split("/").pop();if(!i){console.warn("无法从 imageUrl 提取照片名称:",e);return}await C.delete(`${T}/admin/uploadphoto/photo/${i}`),U.value="",D.value="",t?r.error("旧图片已删除, 已重新上传新图片"):r.info("已删除未使用的图片,如需重新上传,请点击上传按钮")}catch(e){console.error("删除照片失败:",e),r.error("删除失败")}};fe(()=>P.params.tab,t=>{t&&(h.value=t)}),fe(()=>P.params.category,t=>{t&&(w.value=t)});const de=t=>new Date(t).toLocaleString();return(t,e)=>{const i=S("el-empty"),p=S("el-icon"),d=S("el-tooltip"),M=S("el-input"),W=S("el-form-item"),pe=S("el-option"),me=S("el-select"),ve=S("el-upload"),q=S("el-button"),Oe=S("el-form"),J=Fe("lazy");return s(),c("div",ot,[o("nav",st,[o("ul",nt,[(s(),c(N,null,R(De,a=>o("li",{key:a.id,class:G(["nav-item",{active:h.value===a.id}]),onClick:z=>Pe(a.id)},[Ke($(a.title)+" ",1),e[9]||(e[9]=o("div",{class:"active-indicator"},null,-1))],10,rt)),64))]),e[10]||(e[10]=o("p",{class:"nav-desc"},"记录美好瞬间，珍藏珍贵回忆",-1))]),o("section",it,[(s(),V(ye,null,[E(o("div",ut,[(s(!0),c(N,null,R(v(Ce),a=>(s(),c("button",{key:a.id,class:G(["filter-btn",{active:w.value===a.id}]),onClick:z=>xe(a)},$(a.name),11,dt))),128))],512),[[ge,h.value==="messages"]])],1024)),(s(),V(ye,null,[E(o("div",ct,[(s(!0),c(N,null,R(v(Ie),a=>(s(),c("button",{key:a.id,class:G(["filter-btn",{active:w.value===a.id}]),onClick:z=>Me(a)},$(a.name),11,pt))),128))],512),[[ge,h.value==="photos"]])],1024))]),o("main",mt,[h.value==="messages"?(s(),V(_e,{key:0,name:"staggered-fade",tag:"div",class:"message-grid"},{default:u(()=>[(s(!0),c(N,null,R(te.value,(a,z)=>(s(),c("article",{key:z,class:G(["message-card",{"has-media":a.photo}])},[o("header",vt,[o("h3",ft,$(a.name),1),o("span",gt,$(a.category),1)]),o("div",yt,[o("p",null,$(a.content),1)]),a.photo?(s(),c("div",_t,[E(o("img",ht,null,512),[[J,a.photo]])])):I("",!0),o("div",{class:"message-icon",onClick:F=>We(a.id,a.isLiked)},[o("div",wt,[l(v(Xe)),o("span",bt,$(a.likesCount),1)]),b.value==a.userId?(s(),c("div",{key:0,class:"message-delete",onClick:Y(F=>ze(a.id),["stop"])},[l(v(be))],8,Ct)):I("",!0),b.value!==a.userId?(s(),c("div",{key:1,class:"message-report",onClick:Y(F=>Ee(a.id),["stop"])},e[11]||(e[11]=[o("span",null,"举报此留言",-1)]),8,It)):I("",!0)],8,kt)],2))),128))]),_:1})):I("",!0),h.value==="photos"?(s(),V(_e,{key:1,name:"staggered-fade",tag:"div",class:"photo-grid"},{default:u(()=>[(s(!0),c(N,null,R(ae.value,(a,z)=>(s(),c("figure",{key:z,class:"photo-card"},[E(o("img",St,null,512),[[J,a.photo]]),o("figcaption",Ut,[b.value==a.userId?(s(),c("div",{key:0,style:{color:"red","margin-right":"10px"},class:"photo-delete",onClick:Y(F=>Le(a.id),["stop"])},[l(v(be))],8,Dt)):I("",!0),o("time",null,$(de(a.date)),1),o("div",Vt,$(a.category),1)])]))),128))]),_:1})):I("",!0),h.value==="messages"&&!te.value.length?(s(),c("div",$t,[l(i,{description:"暂无留言，快来留下第一个足迹吧~"})])):I("",!0),h.value==="photos"&&!ae.value.length?(s(),c("div",xt,[l(i,{description:"还没有照片，点击右下角上传吧"})])):I("",!0)]),o("div",Mt,[l(d,{effect:"dark",content:h.value==="messages"?"写留言":"传照片",placement:"left"},{default:u(()=>[o("button",{class:"fab-button",onClick:e[0]||(e[0]=a=>h.value==="messages"?L.value=!0:A.value=!0)},[l(p,{size:24},{default:u(()=>[(s(),V(Ye(h.value==="messages"?v(Qe):v(Q))))]),_:1})])]),_:1},8,["content"])]),l(v(we),{modelValue:L.value,"onUpdate:modelValue":e[5]||(e[5]=a=>L.value=a),title:"添加留言",direction:"rtl",size:"40%","before-close":se,"close-on-click-modal":!1},{default:u(()=>[l(Oe,{class:"message-form","label-width":"100px"},{default:u(()=>[l(W,{label:"留言昵称"},{default:u(()=>[l(M,{modelValue:g.value.name,"onUpdate:modelValue":e[1]||(e[1]=a=>g.value.name=a),placeholder:"请输入留言昵称"},null,8,["modelValue"])]),_:1}),l(W,{label:"留言内容"},{default:u(()=>[l(M,{modelValue:g.value.content,"onUpdate:modelValue":e[2]||(e[2]=a=>g.value.content=a),type:"textarea",rows:4,placeholder:"请输入留言内容"},null,8,["modelValue"])]),_:1}),l(W,{label:"留言标签"},{default:u(()=>[l(me,{modelValue:g.value.category,"onUpdate:modelValue":e[3]||(e[3]=a=>g.value.category=a),placeholder:"请选择标签",clearable:""},{default:u(()=>[(s(!0),c(N,null,R(v(Ce),a=>(s(),V(pe,{key:a.id,label:a.name,value:a.id,disabled:a.id==="全部"},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(W,{label:"留言照片"},{default:u(()=>[l(ve,{class:"wall-uploader",action:`${v(T)}/admin/uploadphoto`,"show-file-list":!1,"before-upload":ne,"on-success":Ne,method:"post",name:"photo","auto-upload":!1,ref_key:"uploadWallRef",ref:Z,onChange:ie},{default:u(()=>[o("div",Pt,[D.value?E((s(),c("img",Nt,null,512)),[[J,D.value]]):(s(),c("div",Rt,[l(p,null,{default:u(()=>[l(v(Q))]),_:1}),e[12]||(e[12]=o("p",null,"请选择要上传的留言照片",-1))]))])]),_:1},8,["action"])]),_:1}),l(W,null,{default:u(()=>[o("div",Tt,[j.value?(s(),V(q,{key:0,type:"primary",onClick:e[4]||(e[4]=a=>oe("wall"))},{default:u(()=>[l(p,null,{default:u(()=>[l(v(he))]),_:1}),e[13]||(e[13]=o("span",null,"上传留言照片",-1))]),_:1})):I("",!0),l(q,{type:"primary",onClick:Ae},{default:u(()=>[l(p,null,{default:u(()=>[l(v(ke))]),_:1}),e[14]||(e[14]=o("span",null,"保存留言",-1))]),_:1})])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(v(we),{modelValue:A.value,"onUpdate:modelValue":e[8]||(e[8]=a=>A.value=a),"before-close":se,title:"上传照片",direction:"rtl",size:"40%","close-on-click-modal":!1},{default:u(()=>[l(ve,{class:"photo-uploader",action:`${v(T)}/admin/uploadphoto`,"show-file-list":!1,"before-upload":ne,"on-success":Re,"on-error":Te,method:"post",name:"photo","auto-upload":!1,ref_key:"uploadPhotoRef",ref:ee,onChange:ie},{default:u(()=>[o("div",Wt,[U.value?E((s(),c("img",zt,null,512)),[[J,U.value]]):(s(),c("div",Et,[l(p,null,{default:u(()=>[l(v(Q))]),_:1}),e[15]||(e[15]=o("p",null,"请选择要上传的照片",-1))]))])]),_:1},8,["action"]),l(W,{label:"照片标签",style:{"margin-top":"20px"}},{default:u(()=>[l(me,{modelValue:k.value.category,"onUpdate:modelValue":e[6]||(e[6]=a=>k.value.category=a),placeholder:"请选择照片标签"},{default:u(()=>[(s(!0),c(N,null,R(v(Ie),a=>(s(),V(pe,{key:a.id,label:a.name,value:a.id,disabled:a.id==="全部"},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),o("div",Lt,[j.value?(s(),V(q,{key:0,type:"primary",onClick:e[7]||(e[7]=a=>oe("photo"))},{default:u(()=>[l(p,null,{default:u(()=>[l(v(he))]),_:1}),e[16]||(e[16]=o("span",null,"上传照片",-1))]),_:1})):I("",!0),l(q,{type:"primary",onClick:Be},{default:u(()=>[l(p,null,{default:u(()=>[l(v(ke))]),_:1}),e[17]||(e[17]=o("span",null,"保存照片",-1))]),_:1})])]),_:1},8,["modelValue"])])}}}),Gt=Ze(At,[["__scopeId","data-v-5176656b"]]);export{Gt as default};
